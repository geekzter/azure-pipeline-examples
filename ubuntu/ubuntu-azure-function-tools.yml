# This pipeline is for CI/CD
parameters:
- name: agentType
  displayName: Agent Type
  type: string
  default: Azure Pipelines
  values:
  - Azure Pipelines
  - Container Job
  - Managed DevOps Pool
  - All
- name: mdpName
  displayName: Managed DevOps Pool Name
  type: string
  default: Specify MDP Pool
- name: mdpImageLabel
  displayName: Managed DevOps Pool Image
  type: string
  default: ubuntu-20.04
- name: installFuncTools
  displayName: Install Azure Functions Core Tools
  type: boolean
  default: true
  
trigger: none

jobs:
- ${{ if or(eq(parameters.agentType, 'Azure Pipelines'),eq(parameters.agentType, 'All')) }}:
  - job: hosted
    displayName: Use Azure Pipelines ubuntu-20.04 image
    pool:
      name: 'Azure Pipelines'
      vmImage: 'ubuntu-20.04'
    steps:
    - ${{ if parameters.installFuncTools }}:
      - bash: |
          wget -q https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb
          sudo dpkg -i packages-microsoft-prod.deb  
          sudo apt-get update
          sudo apt-get install azure-functions-core-tools-4  

          # npm i -g azure-functions-core-tools@4 --unsafe-perm true
    - bash: |
        func --version
        python -V
      displayName: 'Use Azure Functions Core Tools'

- ${{ if or(eq(parameters.agentType, 'Managed DevOps Pool'),eq(parameters.agentType, 'All')) }}:
  - job: hosted
    displayName: Use Managed DevOps Pool ${{ parameters.mdpImageLabel }} image
    pool:
      name: '${{ parameters.mdpName }}'
      vmImage: '${{ parameters.mdpImageLabel }}'
    steps:
    - ${{ if parameters.installFuncTools }}:
      - bash: |
          wget -q https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb
          sudo dpkg -i packages-microsoft-prod.deb  
          sudo apt-get update
          sudo apt-get install azure-functions-core-tools-4  

          # npm i -g azure-functions-core-tools@4 --unsafe-perm true
    - bash: |
        func --version
        python -V
      displayName: 'Use Azure Functions Core Tools'

- ${{ if or(eq(parameters.agentType, 'Container Job'),eq(parameters.agentType, 'All')) }}:
  - job: funcTools
    container: mcr.microsoft.com/azure-functions/python:4-python3.11-core-tools
    displayName: Use mcr.microsoft.com/azure-functions container image
    pool:
      name: 'Azure Pipelines'
      vmImage: 'ubuntu-latest'
    steps:
    - bash: |
        func --version
        python -V
      displayName: 'Use Azure Functions Core Tools'
